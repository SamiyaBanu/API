# Assuming $configurationItem holds the CI ID or Name
$ciResourcesUrl = "$sdiBaseUrl/deployment/api/deployments/$configurationItem/resources?resourceTypes=Cloud.vSphere.Machine"

Write-Output "Getting all VMs under CI: $configurationItem"
$ciResources = ExecuteSDICall -sdiUsername $sdiUsername -sdiPassword $sdiPassword -secureSdiPassword $secureSdiPassword -sdiUrl $ciResourcesUrl

foreach ($vm in $ciResources.content) {
    $vmStatus = $vm.status
    $vmId = $vm.id
    $vmName = $vm.name

    Write-Output "VM: $vmName, Status: $vmStatus"

    if ($vmStatus -eq "CREATE_FAILED" -and -not $SkipFailedDeploymentDeletion) {
        Write-Output "Deleting failed VM deployment: $vmName ($vmId)"
        $deleteResponse = DeleteDeploymentById -sdiUsername $sdiUsername -sdiPassword $sdiPassword -secureSdiPassword $secureSdiPassword -deploymentId $vmId -debugOutput $debugOutput -infoOutput $infoOutput
    } elseif ($vmStatus -eq "CREATE_FAILED" -and $SkipFailedDeploymentDeletion) {
        Write-Output "Skipping deletion of failed VM as per switch: $vmName"
    }
}
